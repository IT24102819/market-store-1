<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Sales Reports - Lanka Fresh Mart</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    :root {
      --primary: #249624;
      --primary-dark: #2d7a2d;
      --accent: #ffc107;
      --bg: #f4f6f8;
      --card-bg: #ffffff;
      --text: #23272f;
      --text-light: #ffffff;
      --shadow: 0 4px 24px rgba(44,62,80,0.10);
      --border-color: #eaeaea;
    }
    body {
      background: var(--bg);
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    .dark-mode {
      --bg: #181a20;
      --card-bg: #23272f;
      --text: #f4f6f8;
      --border-color: #3a3f48;
    }
    .navbar {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      padding: 0.75rem 2rem;
      position: sticky;
      top: 0;
      z-index: 1020;
    }
    .navbar-brand {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .navbar-brand i {
      color: var(--primary);
    }
    .navbar-nav .nav-link {
      font-weight: 500;
      color: var(--text);
      margin-right: 18px;
      transition: color 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .navbar-nav .nav-link:hover {
      color: var(--primary);
    }
    .dark-toggle {
      background: transparent;
      color: var(--text);
      border-radius: 50%;
      border: 1px solid var(--border-color);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      margin-left: 12px;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
      position: relative;
    }
    .dark-toggle:hover {
      background: var(--primary);
      color: var(--text-light);
      border-color: var(--primary);
    }
    .dark-toggle .badge {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 50%;
    }
    .container {
      max-width: 1100px;
      margin: 40px auto;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 36px;
    }
    h1 {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 32px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .dark-mode h1 { color: var(--primary); }
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.3rem;
      font-weight: 600;
      margin-top: 32px;
      margin-bottom: 18px;
      color: var(--primary-dark);
    }
    .dark-mode .section-header { color: var(--primary); }
    .report-card {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 24px 20px 18px 20px;
      margin-bottom: 28px;
      border: 1px solid var(--border-color);
      transition: box-shadow 0.2s;
    }
    .report-card:hover {
      box-shadow: 0 6px 32px rgba(44,62,80,0.13);
    }
    .total-sales {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.2rem;
      font-weight: 500;
      color: var(--primary-dark);
      margin-bottom: 18px;
      background: #eafbe7;
      border-radius: 8px;
      padding: 12px 18px;
      width: fit-content;
      box-shadow: 0 2px 8px rgba(44,62,80,0.05);
    }
    .dark-mode .total-sales {
      background: #233c23;
      color: var(--primary);
    }
    .export-btn {
      background: var(--accent);
      color: #23272f;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(44,62,80,0.07);
      transition: background 0.2s, color 0.2s, transform 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .export-btn:hover {
      background: #ffb300;
      color: #181a20;
      transform: translateY(-2px) scale(1.03);
    }
    .table-responsive {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(44,62,80,0.07);
      border: 1px solid var(--border-color);
    }
    table {
      width: 100%;
      background: var(--card-bg);
    }
    th, td {
      padding: 14px;
      text-align: left;
      vertical-align: middle;
      border-top: 1px solid var(--border-color);
    }
    th {
      background: #eafbe7;
      color: var(--primary-dark);
      font-weight: 600;
      font-size: 1rem;
      border-top: none;
    }
    .table th i, .table td i {
      color: var(--primary);
      margin-right: 6px;
    }
    .table thead tr {
      background: #eafbe7;
    }
    tbody tr:hover {
      background: #f7fff7;
    }
    .dark-mode tbody tr:hover {
      background: #1e2a1e;
    }
    .dark-mode table, .dark-mode th, .dark-mode td {
      color: var(--text);
      background-color: var(--card-bg);
      border-color: var(--border-color);
    }
    .delete-button {
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: background 0.2s, transform 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .delete-button:hover {
      background: #b71c1c;
      transform: translateY(-2px);
    }
    .logout-button {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text);
      border-radius: 8px;
      padding: 6px 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s, color 0.2s;
    }
    .logout-button:hover {
      background: var(--primary-dark);
      color: var(--text-light);
      border-color: var(--primary-dark);
    }
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      margin: 20px 0;
    }
    canvas {
      display: block;
      max-width: 100%;
      width: 100% !important;
      height: 400px !important;
    }
    .chart-card {
      background: var(--card-bg);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 28px;
      border: 1px solid var(--border-color);
      transition: box-shadow 0.2s;
    }
    .chart-card:hover {
      box-shadow: 0 6px 32px rgba(44,62,80,0.13);
    }
    .chart-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .dark-mode .chart-title {
      color: var(--primary);
    }
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 28px;
      margin-bottom: 32px;
    }
    .chart-full-width {
      grid-column: 1 / -1;
    }
    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      .chart-container {
        height: 300px;
      }
      canvas {
        height: 300px !important;
      }
    }
    @media (max-width: 700px) {
      .container {
        padding: 16px;
      }
      .report-card {
        padding: 12px 8px 10px 8px;
      }
      .total-sales {
        font-size: 1rem;
        padding: 8px 10px;
      }
      .section-header {
        font-size: 1.1rem;
      }
      .chart-card {
        padding: 16px;
      }
    }
    .form-row {
      display: flex;
      gap: 10px;
    }
    .form-control {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid var(--border-color);
    }
    .btn-primary {
      background: var(--primary);
      border: none;
      padding: 8px 16px;
    }
    .btn-primary:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg">
  <a class="navbar-brand" href="#"><i class="fa fa-leaf"></i> Lanka Fresh Mart</a>
  <div class="collapse navbar-collapse">
    <ul class="navbar-nav ml-auto">
      <li class="nav-item"><a th:href="@{/admin/products}" class="nav-link"><i class="fa fa-box"></i>Manage Products</a></li>
      <li class="nav-item"><a th:href="@{/admin/orders}" class="nav-link"><i class="fa fa-shopping-cart"></i>Manage Orders</a></li>
      <li class="nav-item"><a th:href="@{/admin/reviews}" class="nav-link"><i class="fa fa-star"></i>Manage Reviews</a></li>
    </ul>
    <div class="d-flex align-items-center">
      <form th:action="@{/logout}" method="post" aria-label="Logout form" class="mr-2">
        <button type="submit" class="logout-button"><i class="fa fa-sign-out-alt"></i> Logout</button>
      </form>
      <a th:href="@{https://mailtrap.io/inboxes/4063256/messages(target='_blank')}"
         class="dark-toggle mr-2"
         th:onclick="'window.location.href=\'/admin/reset-email-count\'; return true;'"
         title="View Mailtrap Sandbox">
        <i class="fa fa-bell"></i>
        <span th:if="${newEmailCount > 0}" class="badge badge-danger" th:text="${newEmailCount}"></span>
      </a>
      <button class="dark-toggle" onclick="toggleDarkMode()" title="Toggle dark mode"><i class="fa fa-moon"></i></button>
    </div>
  </div>
</nav>
<div class="container mt-4">
  <h1><i class="fa fa-chart-line"></i> Sales Reports</h1>
  <div class="total-sales">
    <i class="fa fa-coins"></i>
    <span>Total Sales (Last 30 Days):</span>
    <span th:text="${totalSales} + ' LKR'">0 LKR</span>
  </div>

  <!-- Date Range Picker -->
  <div class="report-card">
    <div class="section-header"><i class="fa fa-calendar"></i> Select Date Range</div>
    <form th:action="@{/admin/sales/reports}" method="get">
      <div class="form-row">
        <div class="form-group col-md-5">
          <label for="startDate">Start Date</label>
          <input type="datetime-local" class="form-control" id="startDate" name="startDate">
        </div>
        <div class="form-group col-md-5">
          <label for="endDate">End Date</label>
          <input type="datetime-local" class="form-control" id="endDate" name="endDate">
        </div>
        <div class="form-group col-md-2">
          <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> Filter</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title">
        <i class="fa fa-chart-line"></i>
        Daily Sales Trend
      </div>
      <div class="chart-container">
        <canvas id="dailySalesChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-title">
        <i class="fa fa-chart-pie"></i>
        Product Performance
      </div>
      <div class="chart-container">
        <canvas id="productPerformanceChart"></canvas>
      </div>
    </div>

    <div class="chart-card chart-full-width">
      <div class="chart-title">
        <i class="fa fa-chart-bar"></i>
        Monthly Sales Trend
      </div>
      <div class="chart-container">
        <canvas id="monthlySalesChart"></canvas>
      </div>
    </div>
  </div>

  <div class="report-card">
    <div class="section-header"><i class="fa fa-bolt"></i> Fast Moving Items</div>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead>
        <tr>
          <th><i class="fa fa-box"></i> Product Name</th>
          <th><i class="fa fa-arrow-up"></i> Units Sold</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${fastMoving}">
          <td th:text="${item[0]}"></td>
          <td th:text="${item[1]}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(fastMoving)}">
          <td colspan="2">No fast-moving items</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="report-card">
    <div class="section-header"><i class="fa fa-hourglass-half"></i> Slow Moving Items</div>
    <div class="table-responsive">
      <table class="table mb-0">
        <thead>
        <tr>
          <th><i class="fa fa-box"></i> Product Name</th>
          <th><i class="fa fa-arrow-down"></i> Units Sold</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${slowMoving}">
          <td th:text="${item[0]}"></td>
          <td th:text="${item[1]}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(slowMoving)}">
          <td colspan="2">No slow-moving items</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
  <a th:href="@{/admin/sales/reports/export-csv(days=30)}" class="export-btn mb-3">
    <i class="fa fa-file-csv"></i> Export CSV
  </a>
</div>

<script th:inline="javascript">
  // Debug: Log raw model attributes
  const dailySalesDataRaw = /*[[${dailySalesData}]]*/ '[]';
  const productPerfDataRaw = /*[[${productPerformanceData}]]*/ '[]';
  const monthlySalesDataRaw = /*[[${monthlySalesTrend}]]*/ '[]';
  console.log('Raw Model Attributes:', {
    dailySalesData: dailySalesDataRaw,
    productPerformanceData: productPerfDataRaw,
    monthlySalesTrend: monthlySalesDataRaw
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script th:inline="javascript">
  // Dark mode toggle
  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    const colors = getChartColors();
    if (dailySalesChart) {
      dailySalesChart.options.scales.y.ticks.color = colors.text;
      dailySalesChart.options.scales.x.ticks.color = colors.text;
      dailySalesChart.options.scales.y.grid.color = colors.border;
      dailySalesChart.options.scales.x.grid.color = colors.border;
      dailySalesChart.options.plugins.legend.labels.color = colors.text;
      dailySalesChart.data.datasets[0].borderColor = colors.primary;
      dailySalesChart.data.datasets[0].backgroundColor = colors.primary + '20';
      dailySalesChart.data.datasets[0].pointBackgroundColor = colors.primary;
      dailySalesChart.update();
    }
    if (productPerfChart) {
      productPerfChart.options.plugins.legend.labels.color = colors.text;
      productPerfChart.data.datasets[0].borderColor = colors.background;
      productPerfChart.update();
    }
    if (monthlySalesChart) {
      monthlySalesChart.options.scales.y.ticks.color = colors.text;
      monthlySalesChart.options.scales.x.ticks.color = colors.text;
      monthlySalesChart.options.scales.y.grid.color = colors.border;
      monthlySalesChart.options.scales.x.grid.color = colors.border;
      monthlySalesChart.options.plugins.legend.labels.color = colors.text;
      monthlySalesChart.data.datasets[0].backgroundColor = colors.primary + '80';
      monthlySalesChart.data.datasets[0].borderColor = colors.primary;
      monthlySalesChart.update();
    }
  }

  // Load dark mode preference
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }

  // Chart.js configuration
  Chart.defaults.font.family = "'Segoe UI', 'Roboto', Arial, sans-serif";
  Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text');

  function getChartColors() {
    const isDark = document.body.classList.contains('dark-mode');
    return {
      primary: isDark ? '#4CAF50' : '#249624',
      secondary: isDark ? '#81C784' : '#66BB6A',
      accent: '#FFC107',
      background: isDark ? '#23272f' : '#ffffff',
      text: isDark ? '#f4f6f8' : '#23272f',
      border: isDark ? '#3a3f48' : '#eaeaea'
    };
  }

  // Daily Sales Chart
  let dailySalesChart;
  try {
    console.log('Daily Sales Data from server:', dailySalesDataRaw);
    let dailySalesData = [];
    try {
      dailySalesData = JSON.parse(dailySalesDataRaw || '[]');
      dailySalesData = dailySalesData.map(item => {
        if (Array.isArray(item) && item.length >= 2) {
          return [item[0], parseFloat(item[1])];
        }
        console.warn('Invalid daily sales item:', item);
        return null;
      }).filter(item => item !== null);
    } catch (e) {
      console.error('Error parsing daily sales data:', e);
    }
    console.log('Processed Daily Sales Data:', dailySalesData);

    const dailySalesCtx = document.getElementById('dailySalesChart');
    if (!dailySalesCtx) {
      console.error('Daily Sales Chart canvas not found!');
    } else {
      dailySalesChart = new Chart(dailySalesCtx.getContext('2d'), {
        type: 'line',
        data: {
          labels: dailySalesData.length > 0 ? dailySalesData.map(item => new Date(item[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })) : ['No Data'],
          datasets: [{
            label: 'Daily Sales (LKR)',
            data: dailySalesData.length > 0 ? dailySalesData.map(item => item[1]) : [0],
            borderColor: getChartColors().primary,
            backgroundColor: getChartColors().primary + '20',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: getChartColors().primary,
            pointBorderColor: getChartColors().background,
            pointBorderWidth: 2,
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, labels: { color: getChartColors().text, font: { size: 12 } } },
            tooltip: { callbacks: { label: context => `LKR ${context.parsed.y.toLocaleString()}` } }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: getChartColors().border, drawBorder: false },
              ticks: {
                color: getChartColors().text,
                callback: value => 'LKR ' + value.toLocaleString()
              }
            },
            x: {
              grid: { color: getChartColors().border, drawBorder: false },
              ticks: { color: getChartColors().text }
            }
          }
        }
      });
      console.log('Daily Sales Chart initialized');
    }
  } catch (e) {
    console.error('Error initializing dailySalesChart:', e);
  }

  // Product Performance Chart
  let productPerfChart;
  try {
    console.log('Product Performance Data from server:', productPerfDataRaw);
    let productPerfData = [];
    try {
      productPerfData = JSON.parse(productPerfDataRaw || '[]');
      productPerfData = productPerfData.map(item => {
        if (Array.isArray(item) && item.length >= 3) {
          return [item[0], parseFloat(item[1]), parseFloat(item[2])];
        }
        console.warn('Invalid product performance item:', item);
        return null;
      }).filter(item => item !== null);
    } catch (e) {
      console.error('Error parsing product performance data:', e);
    }
    console.log('Processed Product Performance Data:', productPerfData);

    const productPerfCtx = document.getElementById('productPerformanceChart');
    if (!productPerfCtx) {
      console.error('Product Performance Chart canvas not found!');
    } else {
      productPerfChart = new Chart(productPerfCtx.getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: productPerfData.length > 0 ? productPerfData.map(item => item[0]) : ['No Data'],
          datasets: [{
            data: productPerfData.length > 0 ? productPerfData.map(item => item[2]) : [1],
            backgroundColor: [
              getChartColors().primary,
              getChartColors().secondary,
              getChartColors().accent,
              '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'
            ],
            borderWidth: 2,
            borderColor: getChartColors().background
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: { color: getChartColors().text, font: { size: 11 }, padding: 15 }
            },
            tooltip: { callbacks: { label: context => `${context.label}: LKR ${context.parsed.toLocaleString()}` } }
          }
        }
      });
      console.log('Product Performance Chart initialized');
    }
  } catch (e) {
    console.error('Error initializing productPerfChart:', e);
  }

  // Monthly Sales Chart
  let monthlySalesChart;
  try {
    console.log('Monthly Sales Data from server:', monthlySalesDataRaw);
    let monthlySalesData = [];
    try {
      monthlySalesData = JSON.parse(monthlySalesDataRaw || '[]');
      monthlySalesData = monthlySalesData.map(item => {
        if (Array.isArray(item) && item.length >= 3) {
          return [parseInt(item[0]), parseInt(item[1]), parseFloat(item[2])];
        }
        console.warn('Invalid monthly sales item:', item);
        return null;
      }).filter(item => item !== null);
    } catch (e) {
      console.error('Error parsing monthly sales data:', e);
    }
    console.log('Processed Monthly Sales Data:', monthlySalesData);

    const monthlySalesCtx = document.getElementById('monthlySalesChart');
    if (!monthlySalesCtx) {
      console.error('Monthly Sales Chart canvas not found!');
    } else {
      monthlySalesChart = new Chart(monthlySalesCtx.getContext('2d'), {
        type: 'bar',
        data: {
          labels: monthlySalesData.length > 0 ? monthlySalesData.map(item => {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return monthNames[item[1] - 1] + ' ' + item[0];
          }) : ['No Data'],
          datasets: [{
            label: 'Monthly Sales (LKR)',
            data: monthlySalesData.length > 0 ? monthlySalesData.map(item => item[2]) : [0],
            backgroundColor: getChartColors().primary + '80',
            borderColor: getChartColors().primary,
            borderWidth: 2,
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, labels: { color: getChartColors().text, font: { size: 12 } } },
            tooltip: { callbacks: { label: context => `LKR ${context.parsed.y.toLocaleString()}` } }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: getChartColors().border, drawBorder: false },
              ticks: {
                color: getChartColors().text,
                callback: value => 'LKR ' + value.toLocaleString()
              }
            },
            x: {
              grid: { color: getChartColors().border, drawBorder: false },
              ticks: { color: getChartColors().text }
            }
          }
        }
      });
      console.log('Monthly Sales Chart initialized');
    }
  } catch (e) {
    console.error('Error initializing monthlySalesChart:', e);
  }
</script>
</body>
</html>