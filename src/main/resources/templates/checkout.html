<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Checkout - Lanka Fresh Mart</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
  <style>
    body {
      background: #f4f6f8;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }
    .container {
      margin-top: 40px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(44,62,80,0.08);
      padding: 32px 24px;
      max-width: 900px;
    }
    h1 {
      color: #2d7a2d;
      font-weight: 700;
      margin-bottom: 24px;
      letter-spacing: 1px;
      text-align: center;
    }
    h3 {
      color: #249624;
      font-weight: 600;
      margin-top: 32px;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
    }
    h3 .fa {
      margin-right: 8px;
      color: #ffc107;
    }
    .table {
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(44,62,80,0.07);
      margin-bottom: 24px;
      transition: box-shadow 0.2s;
    }
    .table th, .table td {
      vertical-align: middle !important;
      border-top: none;
    }
    .table th {
      background: #eafbe7;
      color: #2d7a2d;
      font-weight: 600;
      font-size: 1.1rem;
      border-bottom: 2px solid #eaeaea;
    }
    .table td {
      font-size: 1rem;
      color: #2c3e50;
    }
    .form-group label {
      font-weight: 600;
      color: #2d7a2d;
    }
    .form-group input[type="radio"] {
      margin-right: 8px;
    }
    #addressInput {
      margin-top: 10px;
    }
    .btn {
      border-radius: 20px;
      font-weight: 600;
      transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(44,62,80,0.08);
    }
    .btn-success {
      background: #249624;
      color: #fff;
      border: none;
    }
    .btn-success:hover {
      background: #2d7a2d;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px rgba(44,62,80,0.13);
    }
    .btn-secondary {
      background: #2c3e50;
      color: #fff;
      border: none;
    }
    .btn-secondary:hover {
      background: #34495e;
    }
    .btn-info {
      background: #ffc107;
      color: #2d7a2d;
      border: none;
    }
    .btn-info:hover {
      background: #ffe082;
      color: #249624;
    }
    .modal-content {
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(44,62,80,0.13);
      background: #fff;
    }
    .modal-header {
      border-bottom: none;
      background: #eafbe7;
      border-radius: 18px 18px 0 0;
    }
    .modal-title {
      color: #2d7a2d;
      font-weight: 700;
    }
    .card-error {
      color: #e74c3c;
      display: none;
      font-weight: 600;
      margin-top: 8px;
      border-radius: 8px;
      background: #fdecea;
      padding: 8px 12px;
    }
    .alert-danger {
      border-radius: 12px;
      font-size: 1rem;
      background: #fdecea;
      color: #e74c3c;
      box-shadow: 0 2px 8px rgba(44,62,80,0.08);
    }
    @media (max-width: 768px) {
      .container { padding: 16px 4px; }
      .table th, .table td { font-size: 0.95rem; }
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container">
  <h1><i class="fa fa-credit-card"></i> Checkout</h1>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}" role="alert"></div>

  <h3><i class="fa fa-list"></i> Order Details</h3>
  <table class="table table-bordered">
    <thead>
    <tr>
      <th><i class="fa fa-box"></i> Product</th>
      <th><i class="fa fa-sort-numeric-up"></i> Quantity</th>
      <th><i class="fa fa-money-bill-wave"></i> Price</th>
      <th><i class="fa fa-calculator"></i> Subtotal</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${cartItems}">
      <td th:text="${item.product.name}"></td>
      <td th:text="${item.quantity}"></td>
      <td th:text="${#numbers.formatDecimal(item.product.price, 2, 2) + ' LKR'}"></td>
      <td th:text="${item.quantity * item.product.price} + ' LKR' "></td>
    </tr>
    <tr>
      <td colspan="3" class="text-right"><strong>Total:</strong></td>
      <td th:text="${#numbers.formatDecimal(total, 2, 2) + ' LKR'}"></td>
    </tr>
    </tbody>
  </table>

  <h3><i class="fa fa-truck"></i> Delivery Method</h3>
  <div class="form-group">
    <label>
      <input type="radio" name="deliveryMethod" value="PICKUP" required onchange="toggleAddressInput(this)" checked> <i class="fa fa-store"></i> Pick Up
    </label>
  </div>
  <div class="form-group">
    <label>
      <input type="radio" name="deliveryMethod" value="DELIVERY" onchange="toggleAddressInput(this)"> <i class="fa fa-shipping-fast"></i> Delivery
    </label>
  </div>
  <div id="addressInput" class="form-group" style="display: none;">
    <label for="deliveryAddress">Delivery Address:</label>
    <input type="text" id="deliveryAddress" class="form-control" placeholder="Enter your address">
  </div>

  <h3><i class="fa fa-wallet"></i> Payment Method</h3>
  <div class="form-group">
    <label>
      <input type="radio" name="paymentMethod" value="CASH_ON_DELIVERY" required checked> <i class="fa fa-money-bill-wave"></i> Cash on Delivery
    </label>
  </div>
  <div class="form-group">
    <label>
      <input type="radio" name="paymentMethod" value="CARD"> <i class="fa fa-credit-card"></i> Card
    </label>
    <!-- Card Details Modal Trigger -->
    <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#cardModal" th:if="${param.paymentMethod == 'CARD'}"><i class="fa fa-pencil-alt"></i> Enter Card Details</button>
  </div>

  <form th:action="@{/order/place}" method="post" id="orderForm">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <input type="hidden" name="deliveryMethod" id="deliveryMethod">
    <input type="hidden" name="paymentMethod" id="paymentMethod">
    <input type="hidden" name="deliveryAddress" id="deliveryAddressHidden">
    <button type="submit" class="btn btn-success"><i class="fa fa-check"></i> Place Order</button>
    <a th:href="@{/cart}" class="btn btn-secondary"><i class="fa fa-arrow-left"></i> Back to Cart</a>
  </form>

  <!-- Card Details Modal -->
  <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cardModalLabel"><i class="fa fa-credit-card"></i> Enter Card Details</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="cardNumber">Card Number</label>
            <input type="text" class="form-control" id="cardNumber" placeholder="XXXX-XXXX-XXXX-XXXX" maxlength="19" required>
          </div>
          <div class="form-group">
            <label for="expiryDate">Expiry Date (MM/YY)</label>
            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
          </div>
          <div class="form-group">
            <label for="cvv">CVV</label>
            <input type="text" class="form-control" id="cvv" placeholder="XXX" maxlength="4" required>
          </div>
          <div class="card-error" id="cardError"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
          <button type="button" class="btn btn-primary" id="submitCardDetails"><i class="fa fa-check"></i> Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function() {
    $('#submitCardDetails').click(function() {
      var cardNumber = $('#cardNumber').val().replace(/[^0-9]/g, '');
      var expiryDate = $('#expiryDate').val().trim();
      var cvv = $('#cvv').val().replace(/[^0-9]/g, '');
      if (cardNumber.length !== 16 || !/^\d{2}\/\d{2}$/.test(expiryDate) || cvv.length < 3 || cvv.length > 4) {
        $('#cardError').text('Invalid card details. Please check your input. Card: 16 digits, Expiry: MM/YY, CVV: 3-4 digits.').show();
        return;
      }
      $('#cardError').hide();
      $('#paymentMethod').val('CARD');
      $('#cardModal').modal('hide');
      var deliveryMethod = $('input[name="deliveryMethod"]:checked').val();
      if (deliveryMethod) {
        $('#deliveryMethod').val(deliveryMethod);
      }
      var deliveryAddress = $('#deliveryAddress').val();
      if (deliveryMethod === 'DELIVERY' && deliveryAddress) {
        $('#deliveryAddressHidden').val(deliveryAddress);
      }
      $('#orderForm').submit();
    });

    $('input[name="paymentMethod"]').change(function() {
      if ($(this).val() === 'CARD') {
        $('#cardModal').modal('show');
      } else {
        $('#paymentMethod').val($(this).val());
      }
    });

    $('input[name="deliveryMethod"]').change(function() {
      $('#deliveryMethod').val($(this).val());
      toggleAddressInput(this);
    });

    // Function to toggle address input
    function toggleAddressInput(radio) {
      const addressInput = $('#addressInput');
      const deliveryAddressInput = $('#deliveryAddress');
      if (radio.value === 'DELIVERY') {
        addressInput.show();
        const savedAddress = localStorage.getItem('deliveryAddress');
        if (savedAddress) {
          deliveryAddressInput.val(savedAddress);
        }
        $('#deliveryAddressHidden').val(deliveryAddressInput.val());
      } else {
        addressInput.hide();
        localStorage.removeItem('deliveryAddress');
        $('#deliveryAddressHidden').val('');
      }
    }

    // Load saved delivery address if it exists
    const savedDeliveryAddress = localStorage.getItem('deliveryAddress');
    if (savedDeliveryAddress) {
      $('#delivery').prop('checked', true);
      $('#addressInput').show();
      $('#deliveryAddress').val(savedDeliveryAddress);
      $('#deliveryAddressHidden').val(savedDeliveryAddress);
      $('#deliveryMethod').val('DELIVERY');
    }

    // Update deliveryAddress on input change
    $('#deliveryAddress').on('input', function() {
      if ($('#delivery').is(':checked')) {
        localStorage.setItem('deliveryAddress', $(this).val());
        $('#deliveryAddressHidden').val($(this).val());
      }
    });
  });
</script>
<script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" crossorigin="anonymous"></script>
</body>
</html>