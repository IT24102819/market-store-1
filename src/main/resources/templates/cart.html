<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Shopping Cart - Lanka Fresh Mart</title>
  <link rel="stylesheet" href="/css/register.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
<div class="container">
  <h1>Your Cart</h1>

  <!-- Success and Error Messages -->
  <div th:if="${param.success}" class="alert alert-success" th:text="${param.success}" role="alert"></div>
  <div th:if="${error}" class="alert alert-danger" th:text="${error}" role="alert"></div>
  <div th:if="${lowStockWarning}" class="alert alert-warning"
       th:text="'Warning: Some items have low stock!'" role="alert"></div>

  <table class="table table-bordered" role="grid" aria-label="Shopping cart table">
    <thead>
    <tr>
      <th>Image</th>
      <th>Product</th>
      <th>Price</th>
      <th>Quantity</th>
      <th>Total</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="item : ${cartItems}">
      <td>
        <img th:if="${item.product != null}"
             th:src="${item.product.imageUrl}"
             th:alt="${item.product.name}"
             style="width: 100px; height: 100px; object-fit: cover;">
      </td>

      <!-- Product Name -->
      <td th:text="${item.product != null ? item.product.name : 'N/A'}"></td>

      <!-- Product Price -->
      <td th:text="${item.product != null ? #numbers.formatDecimal(item.product.price, 2, 2) : '0.00'}"></td>

      <!-- Quantity Form -->
      Invalid id reference

      <!-- Total Per Item -->
      <td th:text="${item.product != null and item.product.price != null and item.quantity != null ? #numbers.formatDecimal(item.product.price.multiply(BigDecimal.valueOf(item.quantity)), 2, 2) : '0.00'}"></td>

      <!-- Remove Item -->
      <td>
        <form th:if="${item != null and item.id != null}"
              th:action="@{/cart/remove}"
              method="post"
              aria-label="Remove from cart">
          <input type="hidden" name="cartItemId" th:value="${item.id}"/>
          <button type="submit" class="btn btn-sm btn-danger">Remove</button>
        </form>
      </td>
    </tr>

    <!-- Empty Cart -->
    <tr th:if="${#lists.isEmpty(cartItems)}">
      <td colspan="6">Your cart is empty.</td>
    </tr>

    <!-- Cart Total -->

    </tbody>
  </table>

  <!-- Navigation & Actions -->
  <div class="nav-links">
    <p><a th:href="@{/products}" href="/products">Continue Shopping</a></p>
    <p><a th:href="@{/profile}" href="/profile">View Profile</a></p>

    <!-- Checkout Form -->
    <form th:action="@{/cart/checkout}" method="post" aria-label="Checkout form">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <label for="paymentMethod" class="sr-only">Payment Method</label>
      <select name="paymentMethod"
              id="paymentMethod"
              class="form-control"
              style="width: auto; display: inline-block;"
              aria-label="Select payment method">
        <option value="CASH_ON_DELIVERY">Cash on Delivery</option>
        <option value="CARD">Card Payment</option>
      </select>
      <button type="submit" class="btn btn-success">Proceed to Checkout</button>
    </form>

    <!-- Logout Form -->
    <form th:action="@{/logout}" method="post" aria-label="Logout form">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
      <button type="submit" class="logout-button">Logout</button>
    </form>
  </div>
</div>
</body>
</html>